name: RDP + Tailscale (Simple with Real-time Telegram Updates)

on:
  workflow_dispatch:
    inputs:
      ts_tailnet:         { description: "Tailscale tailnet (e.g. you@gmail.com)", required: true }
      ts_api_key:         { description: "Tailscale API key (device admin, no Bearer)", required: true }
      ts_authkey:         { description: "Tailscale Auth key (reusable or ephemeral)", required: true }
      rdp_username:       { description: "RDP Username", required: true }
      rdp_password:       { description: "RDP Password", required: true }
      quick_test:         { description: "Run 5-minute test", type: boolean, default: false }
      runtime_minutes:    { description: "Runtime (max 360; default 355 when not test)", required: false, default: "355" }
      do_purge:           { description: "Purge bullet* devices at start", required: false, default: "true" }
      cycles:             { description: "Number of times to restart (0=infinite)", required: false, default: "0" }
      rdp_count:          { description: "Number of parallel RDP sessions (1-3)", required: false, default: "1" }
      telegram_token:     { description: "Telegram Bot Token", required: true }
      telegram_chat_id:   { description: "Telegram Chat ID", required: true }

permissions:
  contents: read
  actions: write

defaults:
  run:
    shell: pwsh

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 370
    strategy:
      matrix:
        id: ${{ fromJson(inputs.rdp_count == '1' && '[0]' || inputs.rdp_count == '2' && '[0,1]' || '[0,1,2]') }}
      fail-fast: false
    env:
      RDP_USER: ${{ inputs.rdp_username }}
      RDP_PASS: ${{ inputs.rdp_password }}
      TELEGRAM_TOKEN: ${{ inputs.telegram_token }}
      TELEGRAM_CHAT_ID: ${{ inputs.telegram_chat_id }}

    steps:
      - name: Initialize Telegram notifications
        run: |
          $sessionNum = "${{ matrix.id }}"
          $message = "ðŸš€ Workflow Started (Session #$sessionNum)`n`nRepository: ${{ github.repository }}`nWorkflow Run: ${{ github.run_id }}`n`nInitializing..."
          $escapedMessage = $message -replace '"', '\"' -replace "`n", "\n"
          $json = "{`"chat_id`":`"$env:TELEGRAM_CHAT_ID`",`"text`":`"$escapedMessage`"}"
          $json | Out-File -FilePath "$env:TEMP\telegram_init.json" -Encoding UTF8
          curl --max-time 5 -s -X POST "https://api.telegram.org/bot$env:TELEGRAM_TOKEN/sendMessage" -H "Content-Type: application/json; charset=utf-8" -d "@$env:TEMP\telegram_init.json" 2>&1 | Out-Null
          Write-Host "âœ“ Sent initialization message to Telegram"

      - name: Configure hostname and runtime
        run: |
          $id = "${{ matrix.id }}"
          $hn = if ($id -eq "0") { "bullet" } else { "bullet$id" }
          "TS_HOSTNAME=$hn" | Out-File -Append $env:GITHUB_ENV

          function Yes($v){ "$v" -match '^(?i:true|1|yes|on)$' }
          function IntOr($v,$d){ if("$v" -match '^\d+$'){ [int]$v } else { [int]$d } }
          $runtime = IntOr("${{ inputs.runtime_minutes }}",355)
          if (Yes("${{ inputs.quick_test }}")) { $runtime = 3 }
          if (-not (Yes("${{ inputs.quick_test }}")) -and $runtime -lt 6) { $runtime = 355 }
          if ($runtime -gt 360) { $runtime = 355 }
          "RUNTIME_MINUTES=$runtime" | Out-File -Append $env:GITHUB_ENV
          Write-Host "Hostname: $hn  | Runtime: $runtime"

          $message = "âš™ï¸ Configuration Set`n`nHostname: $hn`nRuntime: $runtime minutes"
          $escapedMessage = $message -replace '"', '\"' -replace "`n", "\n"
          $json = "{`"chat_id`":`"$env:TELEGRAM_CHAT_ID`",`"text`":`"$escapedMessage`"}"
          $json | Out-File -FilePath "$env:TEMP\telegram_config.json" -Encoding UTF8
          curl --max-time 5 -s -X POST "https://api.telegram.org/bot$env:TELEGRAM_TOKEN/sendMessage" -H "Content-Type: application/json; charset=utf-8" -d "@$env:TEMP\telegram_config.json" 2>&1 | Out-Null

      - name: Purge old Tailscale devices
        run: |
          function Yes($v){ "$v" -match '^(?i:true|1|yes|on)$' }
          if (Yes("${{ inputs.do_purge }}")) {
            try {
              $auth = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("${{ inputs.ts_api_key }}:"))
              $tn = [uri]::EscapeDataString("${{ inputs.ts_tailnet }}")
              $list = Invoke-RestMethod -Uri "https://api.tailscale.com/api/v2/tailnet/$tn/devices" -Headers @{ Authorization = "Basic $auth" }
              $count = 0
              $targetHostname = "$env:TS_HOSTNAME"
              foreach($d in $list.devices){
                if ($d.hostname -eq $targetHostname){
                  Write-Host "Purging device: $($d.hostname) (ID: $($d.id))"
                  Invoke-RestMethod -Method Delete -Uri "https://api.tailscale.com/api/v2/device/$($d.id)" -Headers @{ Authorization = "Basic $auth" } -ErrorAction SilentlyContinue
                  $count++
                }
              }
              Write-Host "Purged $count device(s) with hostname: $targetHostname"
              
              $message = "ðŸ§¹ Purged Old Devices`n`nHostname: $targetHostname`nRemoved: $count device(s)"
              $escapedMessage = $message -replace '"', '\"' -replace "`n", "\n"
              $json = "{`"chat_id`":`"$env:TELEGRAM_CHAT_ID`",`"text`":`"$escapedMessage`"}"
              $json | Out-File -FilePath "$env:TEMP\telegram_purge.json" -Encoding UTF8
              curl --max-time 5 -s -X POST "https://api.telegram.org/bot$env:TELEGRAM_TOKEN/sendMessage" -H "Content-Type: application/json; charset=utf-8" -d "@$env:TEMP\telegram_purge.json" 2>&1 | Out-Null
            } catch { 
              Write-Host "Purge warning: $($_.Exception.Message)"
              $message = "âš ï¸ Purge skipped or failed"
              $escapedMessage = $message -replace '"', '\"' -replace "`n", "\n"
              $json = "{`"chat_id`":`"$env:TELEGRAM_CHAT_ID`",`"text`":`"$escapedMessage`"}"
              $json | Out-File -FilePath "$env:TEMP\telegram_purge_warn.json" -Encoding UTF8
              curl --max-time 5 -s -X POST "https://api.telegram.org/bot$env:TELEGRAM_TOKEN/sendMessage" -H "Content-Type: application/json; charset=utf-8" -d "@$env:TEMP\telegram_purge_warn.json" 2>&1 | Out-Null
            }
          } else {
            Write-Host "Purge disabled"
            $message = "â„¹ï¸ Purge Disabled"
            $escapedMessage = $message -replace '"', '\"' -replace "`n", "\n"
            $json = "{`"chat_id`":`"$env:TELEGRAM_CHAT_ID`",`"text`":`"$escapedMessage`"}"
            $json | Out-File -FilePath "$env:TEMP\telegram_purge_disabled.json" -Encoding UTF8
            curl --max-time 5 -s -X POST "https://api.telegram.org/bot$env:TELEGRAM_TOKEN/sendMessage" -H "Content-Type: application/json; charset=utf-8" -d "@$env:TEMP\telegram_purge_disabled.json" 2>&1 | Out-Null
          }

      - name: Install and Configure Tailscale
        run: |
          $message = "ðŸ“¦ Installing Tailscale..."
          $escapedMessage = $message -replace '"', '\"' -replace "`n", "\n"
          $json = "{`"chat_id`":`"$env:TELEGRAM_CHAT_ID`",`"text`":`"$escapedMessage`"}"
          $json | Out-File -FilePath "$env:TEMP\telegram_ts_install.json" -Encoding UTF8
          curl --max-time 5 -s -X POST "https://api.telegram.org/bot$env:TELEGRAM_TOKEN/sendMessage" -H "Content-Type: application/json; charset=utf-8" -d "@$env:TEMP\telegram_ts_install.json" 2>&1 | Out-Null

          $ts = "$env:ProgramFiles\Tailscale\tailscale.exe"
          if (-not (Test-Path $ts)) {
            $url = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
            $dst = "$env:TEMP\tailscale.msi"
            Invoke-WebRequest -Uri $url -OutFile $dst
            Start-Process msiexec.exe -ArgumentList "/i","`"$dst`"","/quiet","/norestart" -Wait
            Remove-Item $dst -Force
          }
          & $ts logout | Out-Null
          & $ts up --authkey "${{ inputs.ts_authkey }}" --hostname "$env:TS_HOSTNAME" --accept-dns=true --accept-routes=true
          $ip4 = & $ts ip -4 | Select-Object -First 1
          "TAILSCALE_IP=$ip4" | Out-File -Append $env:GITHUB_ENV
          Write-Host "Tailscale IPv4: $ip4"

          $message = "âœ… Tailscale Connected`n`nHostname: $env:TS_HOSTNAME`nIP: $ip4`nTailnet: ${{ inputs.ts_tailnet }}"
          $escapedMessage = $message -replace '"', '\"' -replace "`n", "\n"
          $json = "{`"chat_id`":`"$env:TELEGRAM_CHAT_ID`",`"text`":`"$escapedMessage`"}"
          $json | Out-File -FilePath "$env:TEMP\telegram_ts_ready.json" -Encoding UTF8
          curl --max-time 5 -s -X POST "https://api.telegram.org/bot$env:TELEGRAM_TOKEN/sendMessage" -H "Content-Type: application/json; charset=utf-8" -d "@$env:TEMP\telegram_ts_ready.json" 2>&1 | Out-Null

      - name: Enable RDP
        run: |
          $message = "ðŸ”§ Configuring RDP..."
          $escapedMessage = $message -replace '"', '\"' -replace "`n", "\n"
          $json = "{`"chat_id`":`"$env:TELEGRAM_CHAT_ID`",`"text`":`"$escapedMessage`"}"
          $json | Out-File -FilePath "$env:TEMP\telegram_rdp_setup.json" -Encoding UTF8
          curl --max-time 5 -s -X POST "https://api.telegram.org/bot$env:TELEGRAM_TOKEN/sendMessage" -H "Content-Type: application/json; charset=utf-8" -d "@$env:TEMP\telegram_rdp_setup.json" 2>&1 | Out-Null

          $u=$env:RDP_USER; $p=$env:RDP_PASS
          $sec = ConvertTo-SecureString $p -AsPlainText -Force
          if (-not (Get-LocalUser -Name $u -EA SilentlyContinue)) {
            New-LocalUser -Name $u -Password $sec -AccountNeverExpires
            Add-LocalGroupMember -Group "Administrators" -Member $u
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $u
          } else {
            Set-LocalUser -Name $u -Password $sec -AccountNeverExpires
            Enable-LocalUser -Name $u
            Add-LocalGroupMember -Group "Administrators" -Member $u -EA SilentlyContinue
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $u -EA SilentlyContinue
          }
          Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name fDenyTSConnections -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" | Out-Null
          Write-Host "RDP ready. user=$u pass=$p host=$env:TS_HOSTNAME ip=$env:TAILSCALE_IP"

          $message = "ðŸŽ‰ RDP READY!`n`nðŸ“ Hostname: $env:TS_HOSTNAME`nðŸŒ IP: $env:TAILSCALE_IP`nðŸ‘¤ User: $u`nðŸ”‘ Pass: $p`n`nðŸ”— Connect: mstsc /v:$env:TS_HOSTNAME`nâ° Runtime: $env:RUNTIME_MINUTES minutes`n`nâš ï¸ Make sure Tailscale is running on your local machine!"
          $escapedMessage = $message -replace '"', '\"' -replace "`n", "\n"
          $json = "{`"chat_id`":`"$env:TELEGRAM_CHAT_ID`",`"text`":`"$escapedMessage`"}"
          $json | Out-File -FilePath "$env:TEMP\telegram_rdp_ready.json" -Encoding UTF8
          curl --max-time 5 -s -X POST "https://api.telegram.org/bot$env:TELEGRAM_TOKEN/sendMessage" -H "Content-Type: application/json; charset=utf-8" -d "@$env:TEMP\telegram_rdp_ready.json" 2>&1 | Out-Null

      - name: Keep Alive Loop
        run: |
          $mins = [int]"${{ env.RUNTIME_MINUTES }}"
          $end = (Get-Date).AddMinutes($mins)
          $lastNotify = Get-Date
          $notifyInterval = 30 # Send status every 30 minutes
          
          while ((Get-Date) -lt $end) {
            $now = Get-Date
            $remaining = [math]::Round(($end - $now).TotalMinutes, 1)
            Write-Host ("â±ï¸ Heartbeat " + $now.ToString("HH:mm:ss") + " | Remaining: $remaining mins")
            
            # Send periodic status updates
            if (($now - $lastNotify).TotalMinutes -ge $notifyInterval) {
              $message = "ðŸ’“ Session Active`n`nHostname: $env:TS_HOSTNAME`nRemaining: $remaining minutes`nEnds at: " + $end.ToString("HH:mm:ss")
              $escapedMessage = $message -replace '"', '\"' -replace "`n", "\n"
              $json = "{`"chat_id`":`"$env:TELEGRAM_CHAT_ID`",`"text`":`"$escapedMessage`"}"
              $json | Out-File -FilePath "$env:TEMP\telegram_heartbeat.json" -Encoding UTF8
              curl --max-time 5 -s -X POST "https://api.telegram.org/bot$env:TELEGRAM_TOKEN/sendMessage" -H "Content-Type: application/json; charset=utf-8" -d "@$env:TEMP\telegram_heartbeat.json" 2>&1 | Out-Null
              $lastNotify = $now
            }
            
            Start-Sleep -Seconds 60
          }

      - name: Send Completion Notification
        if: always()
        run: |
          $message = "âœ… Session Ended`n`nHostname: $env:TS_HOSTNAME`nRuntime: $env:RUNTIME_MINUTES minutes completed`n`nWorkflow finished successfully."
          $escapedMessage = $message -replace '"', '\"' -replace "`n", "\n"
          $json = "{`"chat_id`":`"$env:TELEGRAM_CHAT_ID`",`"text`":`"$escapedMessage`"}"
          $json | Out-File -FilePath "$env:TEMP\telegram_end.json" -Encoding UTF8
          curl --max-time 5 -s -X POST "https://api.telegram.org/bot$env:TELEGRAM_TOKEN/sendMessage" -H "Content-Type: application/json; charset=utf-8" -d "@$env:TEMP\telegram_end.json" 2>&1 | Out-Null
          Write-Host "âœ“ Sent completion notification to Telegram"

  cycle:
    needs: rdp
    runs-on: ubuntu-latest
    if: always() && inputs.cycles != ''
    defaults:
      run:
        shell: bash
    steps:
      - name: Trigger Next Cycle
        run: |
          echo "ðŸ”„ Checking if we should trigger next cycle..."
          CYCLES="${{ inputs.cycles }}"
          
          if [ "$CYCLES" = "0" ]; then
            echo "â™¾ï¸  Infinite cycling enabled - triggering next run"
            SHOULD_CYCLE=true
          else
            echo "Cycles remaining: $CYCLES"
            NEW_CYCLES=$((CYCLES - 1))
            if [ $NEW_CYCLES -ge 0 ]; then
              echo "âœ… Cycles remaining: $NEW_CYCLES - triggering next run"
              SHOULD_CYCLE=true
            else
              echo "â¹ï¸  No cycles remaining - stopping"
              SHOULD_CYCLE=false
            fi
          fi
          
          if [ "$SHOULD_CYCLE" = "true" ]; then
            echo "Waiting 30 seconds before next cycle..."
            sleep 30
            
            echo "Triggering new workflow run..."
            curl -X POST \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token ${{ github.token }}" \
              "https://api.github.com/repos/${{ github.repository }}/actions/workflows/rdp-tailscale-telegram-simple.yml/dispatches" \
              -d '{
                "ref": "main",
                "inputs": {
                  "ts_tailnet": "${{ inputs.ts_tailnet }}",
                  "ts_api_key": "${{ inputs.ts_api_key }}",
                  "ts_authkey": "${{ inputs.ts_authkey }}",
                  "rdp_username": "${{ inputs.rdp_username }}",
                  "rdp_password": "${{ inputs.rdp_password }}",
                  "quick_test": "${{ inputs.quick_test }}",
                  "runtime_minutes": "${{ inputs.runtime_minutes }}",
                  "do_purge": "true",
                  "cycles": "'$NEW_CYCLES'",
                  "rdp_count": "${{ inputs.rdp_count }}",
                  "telegram_token": "${{ inputs.telegram_token }}",
                  "telegram_chat_id": "${{ inputs.telegram_chat_id }}"
                }
              }'
            
            echo "âœ… Next cycle triggered!"
            
            # Send Telegram notification
            MESSAGE="ðŸ”„ Cycle Complete - Next Run Started\\n\\nPrevious Run: ${{ github.run_id }}\\nCycles Remaining: $NEW_CYCLES"
            curl --max-time 5 -s -X POST "https://api.telegram.org/bot${{ inputs.telegram_token }}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\":\"${{ inputs.telegram_chat_id }}\",\"text\":\"$MESSAGE\"}" 2>&1 > /dev/null
          fi
